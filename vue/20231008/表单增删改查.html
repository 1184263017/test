<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./js/vue.js"></script>
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.9.0/css/fontawesome.min.css">
    <title>Document</title>
</head>

<body>
    <div id="app">

    </div>
    <template id="t1">
        <div>
            <h1>待办事项</h1>
            <div class="input-group my-3">
                <input type="text" class="form-control" placeholder="输入标题" v-model="title">
                <button class="btn btn-primary" type="button" @click="add" :disabled="title === ''">添加</button>
            </div>
            <div>
                <button type="button" class="btn btn-info" @click="search(0)" :disabled="activeStatus === 0">全部</button>
                <button type="button" class="btn btn-warning" @click="search(1)"
                    :disabled="activeStatus === 1">未完成</button>
                <button type="button" class="btn btn-primary" @click="search(2)"
                    :disabled="activeStatus === 2">进行中</button>
                <button type="button" class="btn btn-success" @click="search(3)"
                    :disabled="activeStatus === 3">已完成</button>
            </div>
            <table class="table">
                <thead>
                    <tr>
                        <th>标题</th>
                        <th>状态</th>
                        <th>状态切换</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="v in pageLsit" :key="v.id" :class="statusStyle[v.status]">
                        <td>{{v.title}}</td>
                        <td>{{status[v.status]}}</td>
                        <td>
                            <button v-show="v.status !== 1" type="button" class="btn btn-warning"
                                @click="save(v.id,1)">未完成</button>
                            <button v-show="v.status !== 2" type="button" class="btn btn-primary"
                                @click="save(v.id,2)">进行中</button>
                            <button v-show="v.status !== 3" type="button" class="btn btn-success"
                                @click="save(v.id,3)">已完成</button>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger" @click="del(v.id)">删除</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <nav aria-label="Page navigation example">
                <ul class="pagination">
                    <li class="page-item" @click="upOrDown(1)">
                        <a class="page-link" href="#" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item" v-for="v of count" :key="v" @click="page(v)"><a class="page-link"
                            href="#">{{v}}</a></li>
                    <li class="page-item" @click="upOrDown(2)">
                        <a class="page-link" href="#" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </template>
    <script type="module">
        // 待办事项
        /* 
            1. 获取数据(xhr)
                1.1 数据接口
                1.2 接口参数
                1.3 接口返回值
            2. 展示数据
                2.1 API 返回值,保存到data对象属性中
                2.2 使用展示数据
                2.3 对特定的数据增加样式
            3. 添加数据
                3.1 收集数据
                3.2 传数据调用接口添加数据
                3.3 刷新页面(重新获取后端数据)
                3.4 清理页面
            4. 删除数据
                4.1 收集数据
                4.2 传数据调用接口
                4.3 刷新页面
            5. 修改数据(局部修改状态)
                5.1 收集数据
                5.2 传数据调用接口
                5.3 刷新页面
            
        */
        import { saveTodoApi, delTodoApi, addTodoApi, getTodoListsApi } from './api/todo.js'
        const bastUrl = 'http://127.0.0.1:3000';
        const vm = new Vue({
            el: '#app',
            template: '#t1',
            data() {
                return {
                    statusStyle: { 1: 'table-warning', 2: 'table-primary', 3: 'table-success' },
                    status: { 1: '未完成', 2: '进行中', 3: '已完成' },
                    lists: [],
                    pageLsit: [],
                    title: '',
                    activeStatus: 0,
                    count: 1,
                    page_v: 1,
                    limit: 4
                }
            },
            async created() {
                this.lists = await getTodoListsApi();
            },
            watch: {
                // lists() {
                //     // this.pageLsit = ;
                //     this.count = Math.ceil(this.lists.length / 2);
                //     console.log(count);
                // }
                lists: {
                    handler(newValue, oldValue) {
                        this.pageLsit = this.lists.slice(0, this.limit);
                        this.count = Math.ceil(this.lists.length / this.limit);
                    },
                    immediate: true,
                }
            },
            methods: {
                // 添加
                async add() {
                    if (this.title === '') {
                        alert('标题不能为空');
                        return
                    }
                    const data = JSON.stringify({
                        title: this.title,
                        status: 1
                    })
                    await addTodoApi(data);
                    this.lists = await getTodoListsApi();
                    this.title = ''
                },
                // 删除
                async del(id) {
                    if (confirm('是否删除')) {
                        await delTodoApi(id);
                        await this.search(this.activeStatus);
                    }
                },
                // 修改
                async save(id, status) {
                    await saveTodoApi(id, JSON.stringify({ status }));
                    await this.search(this.activeStatus);
                },
                // 搜索
                async search(status = 0) {
                    this.activeStatus = status;
                    // 查询全部
                    if (status === 0) {
                        this.lists = await getTodoListsApi();
                        return
                    }
                    this.lists = await getTodoListsApi({ status });
                },
                //分页
                page(page) {
                    this.page_v = page;
                    this.pageLsit = this.lists.slice((page - 1) * 2, (page - 1) * 2 + this.limit);
                },
                //上一页下一页
                upOrDown(type) {
                    let page = 0;
                    if (type == 2) {
                        page = this.page_v + 1 > this.count ? this.count : this.page_v + 1;
                    } else {
                        page = this.page_v - 1 < 1 ? 1 : this.page_v - 1;
                    }
                    this.page_v = page;
                    this.pageLsit = this.lists.slice((page - 1) * 2, (page - 1) * 2 + this.limit);
                }
            },
        })
    </script>
</body>

</html>