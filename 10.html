<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <style>
        table {
            text-align: center;
            font-size: 14px;
            width: 870px;
        }

        td {
            width: 80px;
        }

        button {
            font-size: 12px;
            width: 50px;
            height: 30px;
            border-radius: 3px;
            background-color: orange;
            color: white;
        }

        .but {
            display: flex;
            height: 36px;
            align-items: center;
        }

        /* 样式可以根据您的需求进行自定义 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            width: 300px;
            padding: 20px;
            border-radius: 5px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .modal-content span{
            float: right;
            color: #999;
            cursor: pointer;

        }

        /* .userInfoForm_d{
            border: 1px red solid;
        } */
        .userInfoForm_d label {
            width: 80px;
            /* border: 1px red solid; */
            display: inline-block;
        }

        .userInfoForm_d input {
            outline: none;
            border: 1px #666 solid;
            border-radius: 3px;
        }

        /* h2{
            border: 1px solid;
            
        } */
        .head {
            width: 870px;
            margin: 0 auto;
            border: 1px solid;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #openModal {
            font-size: 12px;
            width: 70px;
            height: 30px;
            border-radius: 3px;
            background-color: green;
            color: white;
            position: absolute;
            right: 0px;
            bottom: 0px;
            /* margin-le: 10px; */
        }

        #excel {
            font-size: 12px;
            width: 70px;
            height: 30px;
            border-radius: 3px;
            background-color: green;
            color: white;
            position: absolute;
            right: 70px;
            bottom: 0px;
            /* margin-le: 10px; */
        }

        .serce {
            /* border: 1px solid; */
            width: 200px;
            height: 20px;
            display: flex;
            position: absolute;
            right: 150px;
            bottom: 10px;
        }

        .serce input {
            border: 1px solid;
            width: 130px;
            height: 17px;
            border: 1px #666 solid;
            border-radius: 3px;
            outline: none;
            font-size: 12px;
            text-align: center;
        }

        .serce button {
            border: 1px solid;
            width: 40px;
            height: 20px;
        }

        .page{
            margin:0 auto;
            /* border: 1px solid; */
            width: 110px;
            margin-top: 10px;
            font-size: 14px;
        }
        .page span{
            cursor: pointer;
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <div class="head">
        <h2>用户信息表</h2>
        <div class="serce">
            <input type="text" name="keyword" id="serce" placeholder="输入用户姓名进行查询">
            <button onclick="serce(document.getElementById('serce').value)">搜索</button>
        </div>
        <button id="openModal">新增用户</button>
        <button id="excel">导出Excel</button>
    </div>

    <table border="1px" style="margin: auto" id="table">
        <tr id="title">
            <td class="td">id</td>
            <td>姓名</td>
            <td>email</td>
            <td>登录ip</td>
            <td>登录时间</td>
            <td>添加时间</td>
            <td>登陆次数</td>
            <td>管理员描述</td>
            <td>操作</td>
        </tr>
    </table>
    <div class="page">
        <span>上一页</span>
        <span>下一页</span>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span id="cha">x</span>
            <h2>添加用户信息</h2>
            <form action="" id="userInfoForm">
                <input type="hidden" id="type" value="add">
                <input type="hidden" id="user_id" name="id">
                <div class="userInfoForm_d">
                    <label for="username">用户姓名</label>
                    <input type="text" id="username" name="user_name">
                </div>
                <div class="userInfoForm_d">
                    <label for="email">email</label>
                    <input type="text" id="email" name="email">
                </div>
                <div class="userInfoForm_d">
                    <label for="desc">管理员描述</label>
                    <input type="text" id="desc" name="desc">
                </div>
                <div class="userInfoForm_d">
                    <button type="submit">提交</button>
                </div>

            </form>
        </div>

    </div>
    <script>
        const openModalButton = document.getElementById('openModal');
        const modal = document.getElementById('myModal');
        openModalButton.addEventListener('click', () => {
            modal.style.display = 'block';
        });
        document.getElementById('cha').addEventListener('click', () => {
            modal.style.display = 'none';
        });
        userInfoForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const name = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const desc = document.getElementById('desc').value;
            const type = document.getElementById('type').value;

            console.log('姓名:', name);
            console.log('电子邮件:', email);
            console.log('管理员描述:', desc);
            if (!name) {
                alert('请填写用户姓名')
                return;
            }
            if (!email) {
                alert('请填写电子邮件')
                return;
            }
            if (!desc) {
                alert('请填写管理员描述')
                return;
            }
            const data = {
                name, email, desc
            }
            if (type == 'add') {
                addUser(data);
            } else {
                const id = document.getElementById('user_id').value;
                data.id = id;
                saveUser(data);
            }

        });
        const url = 'http://www.tp6.com/api/index/'
        window.onload = () => {
            // promise 异步返回数据操作
            const pro = getApi(url + 'getUserList', null, 'GET');
            getUserList(pro);

            // pro.then((data) => {
            //     let str = '';
            //     const arr = data;
            //     for (let i = 0; i < arr.length; i++) {
            //         let targetSpan = document.createElement('tr')
            //         targetSpan.innerHTML = `
            //                 <td>${arr[i]['admin_id']}</td>
            //                 <td>${arr[i]['user_name']}</td>
            //                 <td>${arr[i]['email']}</td>
            //                 <td>${arr[i]['last_ip']}</td>
            //                 <td>${new Date(arr[i]['add_time'] * 1000).toLocaleString()}</td>
            //                 <td>${new Date(arr[i]['last_login'] * 1000).toLocaleString()}</td>
            //                 <td>${arr[i]['login_count']}</td>
            //                 <td>${arr[i]['desc']}</td>
            //             `
            //         container.appendChild(targetSpan)
            //     }
            // }).catch((e) => {
            //     alert(e);
            // })


            let container = document.getElementById('table')
            let targetSpan = document.createElement('tr')
            targetSpan.innerHTML = `
                            <td>001</td>
                            <td>我是同步数据</td>
                            <td>123456789@qq.com</td>
                            <td>127.0.0.1</td>
                            <td>2018/6/28 10:19:44</td>
                            <td>2018/6/28 10:19:44}</td>
                            <td>10</td>
                            <td>我是同步数据</td>
                            <td class='but'>
                                <button>修改</button>
                                <button>删除</button>
                            </td>
                        `
            container.appendChild(targetSpan)
        }

        function getApi(url, data, type) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    type: type,
                    url: url,
                    data: data,
                    dataType: "json",//数据类型为json
                    success: function (response) {
                        console.log(response);
                        if (response.code == 1) {
                            resolve(response)
                        } else {
                            reject(new Error(response.msg))
                        }
                    },
                })
            })
        }

        async function getUserList(pro) {
            try {
                const res = await pro;
                let container = document.getElementById('table')
                let str = '';
                const arr = res.data;
                for (let i = 0; i < arr.length; i++) {
                    let targetSpan = document.createElement('tr')
                    targetSpan.innerHTML = `
                            <td>${arr[i]['admin_id']}</td>
                            <td>${arr[i]['user_name']}</td>
                            <td>${arr[i]['email']}</td>
                            <td>${arr[i]['last_ip']}</td>
                            <td>${new Date(arr[i]['add_time'] * 1000).toLocaleString()}</td>
                            <td>${new Date(arr[i]['last_login'] * 1000).toLocaleString()}</td>
                            <td>${arr[i]['login_count']}</td>
                            <td>${arr[i]['desc']}</td>
                            <td class='but'>
                                <button onclick=getUserInfo(${arr[i]['admin_id']})>修改</button>
                                <button onclick=del(${arr[i]['admin_id']})>删除</button>    
                            </td>

                        `
                    container.appendChild(targetSpan)
                }
            } catch (e) {
                alert(e)
            }
        }

        function del(id) {
            let isDel = confirm('是否删除当前该条数据?');
            console.log(isDel);
            if (!isDel) {
                return;
            }
            const pro = getApi(url + 'delUser', { id }, 'POST');
            pro.then((res) => {
                alert(res.msg)
                location.reload();
            }).catch((e) => {
                alert(e)
            })
        }

        function addUser(data) {
            const pro = getApi(url + 'addUser', data, 'POST');
            pro.then((res) => {
                alert(res.msg)
                location.reload();
            }).catch((e) => {
                alert(e)
            })
        }

        function saveUser(data) {
            const pro = getApi(url + 'saveUser', data, 'POST');
            pro.then((res) => {
                alert(res.msg)
                location.reload();
            }).catch((e) => {
                alert(e)
            })
        }

        function getUserInfo(id) {
            const pro = getApi(url + 'getUserInfo', { id }, 'POST');
            pro.then((res) => {
                // console.log(res.data);
                document.getElementById('username').value = res.data.user_name
                document.getElementById('email').value = res.data.email
                document.getElementById('desc').value = res.data.desc
                document.getElementById('type').value = 'update'
                document.getElementById('user_id').value = res.data.admin_id
                document.getElementById('myModal').style.display = 'block';
            }).catch((e) => {
                alert(e)
            })
        }

        function serce(keyword) {
            const pro = getApi(url + 'getUserList', { 'name': keyword }, 'POST');
            getUserList(pro);

            const tab = document.getElementById('table')
            const children = tab.children;
            for (let i = children.length - 1; i > 0; i--) {
                tab.removeChild(children[i]);
            }
        }

        document.getElementById('excel').addEventListener('click', () => {
            let data;
            const pro = getApi(url + 'getUserList', null, 'GET');
            pro.then((res) => {
                data = res.data.map((v) => {
                    return [
                        v['user_name'],
                        v['email'],
                        v['last_ip'],
                        v['desc']
                    ]
                })
                data.unshift(["姓名", "email", "登录ip", "描述"])

                const worksheet = XLSX.utils.aoa_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");

                const excelBlob = new Blob([s2ab(XLSX.write(workbook, { bookType: 'xlsx', type: 'binary' }))], {
                    type: 'application/octet-stream'
                });

                const downloadLink = document.createElement("a");
                downloadLink.href = URL.createObjectURL(excelBlob);
                downloadLink.download = "data.xlsx";
                downloadLink.click();
            }).catch((e) => {
                alert(e)
            })
        });
        function s2ab(s) {
            const buf = new ArrayBuffer(s.length);
            const view = new Uint8Array(buf);
            for (let i = 0; i < s.length; i++) {
                view[i] = s.charCodeAt(i) & 0xFF;
            }
            return buf;
        }
    </script>
</body>

</html>