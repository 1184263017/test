<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./static/favicon.ico" type="images/x-ico" />
    <link rel="stylesheet" href="./css/login.css">
    <link rel="stylesheet" href="./css/bootstrap-5.3.0-alpha1-dist/css/bootstrap.min.css">
    <title>登录</title>
    <style>
        .jg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: none;
        }
    </style>
</head>

<body>
    <div class="alert alert-danger jg" id="jg" role="alert">
        登录失败,可能是密码错误
    </div>
    <div class="modal_box_edit" id="modal_box_add">
        <div class="addform">
            <h5>忘记密码邮箱修改</h5>
            <span data-action="add_close" class="add_close">X</span>
            <form action="" name="addform">
                <div class="mb-3 row d1">
                    <label for="email" class="col-sm-2 col-form-label">邮箱:</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="email" name="email">
                    </div>
                    <span style="display:none;" id="email_msg_edit">邮箱格式不正确</span>
                </div>
                <div class="d1 d2">
                    <button data-action="add_form" class="btn btn-primary btn-sm" type="submit">提交</button>
                    <button data-action="add_close" class="btn btn-primary btn-sm" type="submit">关闭</button>
                </div>
            </form>
        </div>
    </div>
    <div class="main">
        <div class="background">
            <img src="./static/login1_1.2.png" alt="">
        </div>
        <div class="login">
            <div class="lg_center">
                <div class="img">
                    <img src="./static/logo.svg" alt="">
                </div>
                <div class="logon">
                    <span>登录</span>
                </div>
                <div class="username">
                    <img src="./static/icon-user.png" alt="">
                    <input type="text" placeholder="请输入用户名" id="username" value="">
                </div>
                <div class="username">
                    <img src="./static/icon-password.png" alt="">
                    <input type="password" placeholder="请输入密码" id="password" value="">
                    <img src="./static/icon-eye.png" alt="" id="qiehuan">
                </div>
                <div class="tishi">
                    <input type="checkbox" name="remember" id="remember">
                    <label for="remember">记住密码</label>
                    <span class="forget" data-action="add">忘记密码</span>
                </div>
                <div class="but">
                    <button id="but" type="button" data-action="login">登录</button>
                </div>
                <!-- <div class="forget">
                    <span>忘记密码</span>
                </div> -->
            </div>
        </div>
    </div>
    <script type="module">
        import on from './js/on.js';
        import PocketBase from './js/pocketbase.es.js';
        import confirm from './js/confirm.js';

        const pb = new PocketBase('http://127.0.0.1:8090');
        /* ----------校验是否登录---------- */
        if (pb.authStore.token !== '') {
            location.href = './index.html';
        }
        if (localStorage.getItem('userinfo') !== null) {
            const userinfo = JSON.parse(localStorage.getItem('userinfo'));
            document.getElementById('username').value = userinfo.username;
            document.getElementById('password').value = userinfo.password;
            document.getElementById('remember').checked = true;
        }
        const obj = {
            async login() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                if (!username) {
                    alert('请输入用户名')
                    return;
                }
                if (!password) {
                    alert('请输入密码')
                    return;
                }
                try {
                    const authData = await pb.collection('users').authWithPassword(
                        username,
                        password,
                    );
                    // 记录密码用作比修改密码时的比对
                    localStorage.setItem('userpassword', JSON.stringify({ password }));
                    // 记住密码
                    if (document.getElementById('remember').checked == true) {
                        localStorage.setItem('userinfo', JSON.stringify({ username, password }));
                    } else {
                        localStorage.removeItem('userinfo');
                    }
                    // console.log('登录成功');
                    location.href = './index.html'
                } catch (error) {
                    console.log('登录失败');
                    document.getElementById('jg').style.display = 'block';
                }
            },
            add() {
                document.getElementById('modal_box_add').style.display = 'block';
            },
            // 关闭添加
            add_close(e) {
                e.preventDefault();
                document.getElementById('modal_box_add').style.display = 'none';
            },
            async add_form(e) {
                e.preventDefault();
                const editform = document.editform;
                const email = validate(addform.email, (v) => /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(v));
                if (!(email)) {
                    return false;
                }
                // 重置密码
                await pb.collection('users').requestPasswordReset(addform.email.value);

                confirm({ title: '邮件发送成功', center: '请前往邮箱重新设置密码' }).finally(() => {
                    document.getElementById('modal_box_add').style.display = 'none';
                })

            }
        };
        /* ---------登录---------- */
        on('click', obj);
        /* ----------回车登录---------- */
        // todo 可优化
        document.addEventListener('keydown', (e) => {
            if (e.key == 'Enter') {
                obj.login();
            }
        })
        /* ----------切换是否显示密码---------- */
        const qiehuan = document.getElementById('qiehuan');
        qiehuan.addEventListener('click', function () {
            ''.includes('icon-eye.png')
            if (qiehuan.src.includes('icon-eye.png')) {
                document.getElementById('password').type = 'text';
                qiehuan.src = qiehuan.src.replace('icon-eye.png', 'icon-eye_no.png')
                return;
            }
            if (qiehuan.src.includes('icon-eye_no.png')) {
                document.getElementById('password').type = 'password';
                qiehuan.src = qiehuan.src.replace('icon-eye_no.png', 'icon-eye.png')
                return;
            }
        })


        /* ----------------验证输入----------------- */
        document.addEventListener('input', function (e) {
            const name = e.target.name;
            switch (true) {
                case name === 'email':
                    validate(e.target, (v) => /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(v))
                    break;
            }
        })
        function validate(e, cb) {
            const name = e.name;
            const sp_edit = document.getElementById(`${name}_msg_edit`);
            const res = cb(e.value);
            if (!res) {
                sp_edit != undefined ? sp_edit.style.display = 'block' : '';
            } else {
                sp_edit != undefined ? sp_edit.style.display = 'none' : '';
            }
            return res;
        }
    </script>
</body>

</html>